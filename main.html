<!DOCTYPE html>
<html>
   <head>
      <meta charset = "utf-8">
      <style type="text/css">
          img{
              width: 30px;
              height: 39px;
          }
      </style>
      
   </head>
   <body>
        <p id="bot1"></p>
        <p id="bot2"></p>
        <p id="bot3"></p>
        <input type="text" id = "playerin">
        <input type="button" value="打出" id="event"><p id="player"></p>
        <hr>
        <p id="display"></p>


        
      <script >
          //<!--
            
        let dictionary=["1W","2W","3W","4W","5W","6W","7W","8W","9W","1T","2T","3T","4T","5T","6T","7T","8T","9T","1S","2S","3S","4S","5S","6S","7S","8S","9S","DONG","NAN","XI","BEI","ZHONG","FA","BAI",""];
        //0-8 1w(萬)-9w 9-17 1t(桶)-9t 18-26 1s(索)-9s 27-33東南西北中發白
        function mahjong(str){
            for(let i=0;i<34;i++)
                if(str==dictionary[i])
                    return i;
        }
        function sortfunc(a,b){
            return a-b;
        }
        class handCard{//手牌->16+1 or 13+1
            //Array listenList
            //let hand[17]
            //let num[34]
            //let newCard
            listenList=[];//聽甚麼牌
            hand=[];//手牌
            num=[];//34種牌的出現次數
            newCard=34;//剛摸到的牌 34=null
            init(){
                for(let i=0;i<34;i++)
                    this.num[i]=0;
            }
            in(array){
                this.init();
                for(let i=0;i<array.length;i++){
                    this.hand[i]=array[i];
                    this.num[array[i]]++;
                }
            }
            _sort(){
                this.hand.sort(sortfunc);   
            }
            AIdraw(){//AI丟牌
                //待補
                return 0;//index
            }
            get_listen(){
                stopped = 0,has=0,num=[];
                function ifwin(n) {//第幾個對子
                    //一次取一個順子或刻子
                    if (n == 5)
                        has = 1;
                    if (stopped || has)
                        return;
                    for (let i = 0; i < 9; i++) {
                        if (num[i] > 2) {
                            num[i] -= 3;
                            ifwin(n + 1);
                            num[i] += 3;
                        }
                        if (i < 7 && num[i] && num[i + 1] && num[i + 2]) {
                            num[i]--;
                            num[i + 1]--;
                            num[i + 2]--;
                            ifwin(n + 1);
                            num[i]++;
                            num[i + 1]++;
                            num[i + 2]++;
                        }
                        if (num[i])
                            stopped = 1;
                    }
                    if (stopped || has)
                        return;
                    for (let i = 9; i < 18; i++) {
                        if (num[i] > 2) {
                            num[i] -= 3;
                            ifwin(n + 1);
                            num[i] += 3;
                        }
                        if (i < 16 && num[i] && num[i + 1] && num[i + 2]) {
                            num[i]--;
                            num[i + 1]--;
                            num[i + 2]--;
                            ifwin(n + 1);
                            num[i]++;
                            num[i + 1]++;
                            num[i + 2]++;
                        }
                        if (num[i])
                            stopped = 1;
                    }
                    if (stopped || has)
                        return;
                    for (let i = 18; i < 27; i++) {
                        if (num[i] > 2) {
                            num[i] -= 3;
                            ifwin(n + 1);
                            num[i] += 3;
                        }
                        if (i < 25 && num[i] && num[i + 1] && num[i + 2]) {
                            num[i]--;
                            num[i + 1]--;
                            num[i + 2]--;
                            ifwin(n + 1);
                            num[i]++;
                            num[i + 1]++;
                            num[i + 2]++;
                        }
                        if (num[i])
                            stopped = 1;
                    }
                    if (stopped || has)
                        return;
                    for (let i = 27; i < 34; i++) {
                        if (num[i] >= 3) {
                            num[i] -= 3;
                            ifwin(n + 1);
                            num[i] += 3;
                        }
                        if (num[i])
                            stopped = 1;
                    }
                }
                function solve(dat){
                    //init
                    num=dat;
                    has=0,stopped=0;
                    //generate listen list
                    let listen=[];//聽牌
                    for(let i=0;i<34;i++){//每種牌都放一次
                        if(num[i]==4)
                            continue;
                        num[i]++;
                        for (j = 0; j < 34; j++) {//拔掉眼睛
                            if (num[j] > 1) {
                                stop = 0;
                                num[j] -= 2;
                                ifwin(0);
                                num[j] += 2;
                            }
                        }
                        num[i]--;
                        if (has) {//如果能湊成5個順子或刻子
                            has = 0;
                            listen.push(i);
                        }
                    }
                    return listen;//把聽牌名單傳回去
                }
                this.listenList=solve(num);
            }
            show_listen(){
                if(this.listenList.length==0)
                    return "not ready";
                tmp="";
                for(let i=0;i<listenList.length;i++)
                    tmp+=listenList[i].toString()+" ";
                return tmp;
            }
        }
        
      
        let allCard=[];
        let handOfCard=[];//0=player 1,2,3=bot 1,2,3
        let bot1=document.getElementById("bot1");
        let bot2=document.getElementById("bot2");
        let bot3=document.getElementById("bot3");
        let player=document.getElementById("player");
        let draw=document.getElementById("display");
        for(let i=0;i<34;i++){
            for(let j=0;j<4;j++)
                allCard[i*4+j]=mahjong(dictionary[i]);
        }
        for(let i=0;i<136;i++){//洗牌
            let idx=Math.floor(Math.random()*136);
            [allCard[i],allCard[idx]]=[allCard[idx],allCard[i]];//swap
        }

        let current=0;
        for(let i=0;i<4;i++){
            let tmp=[];
            for(let j=0;j<16;j++)
                tmp[j]=allCard[current++];
            tmp[16]=34;
            handOfCard[i]=new handCard();
            handOfCard[i].in(tmp);
            handOfCard[i]._sort();  
        } 
        function drawCard(){       
            return allCard[current++];
        }
        
        function display(n,hand){
            let str="";
            for(let i=0;i<16;i++)
                str+="<img src='"+dictionary[hand[i]]+".png'>  ";
            str+="||||"+"<img src='"+dictionary[hand[16]]+".png'>  ";
            if(n==0)
                player.innerHTML=str;
            else if(n==1)
                bot1.innerHTML=str;
            else if(n==2)
                bot2.innerHTML=str;
            else if(n==3)
                bot3.innerHTML=str;
        }
        function display3(str){
            draw.innerHTML=str;
        }
        handOfCard[0].hand[16]=drawCard();
        handOfCard[0].num[handOfCard[0].hand[16]]++;
        display(1,handOfCard[1].hand);
        display(2,handOfCard[2].hand);
        display(3,handOfCard[3].hand);
        display(0,handOfCard[0].hand);
        
        
        let str1="";
        let state=[];//紀錄牌局
        let discard;//打出來的牌

        function playerIn(){
            playerInput=1;
            discard=parseInt(document.getElementById("playerin").value)-1;
        }
        document.getElementById("event").addEventListener("click",playerIn,false);
        function cont(n){
            handOfCard[n]._sort();
            discard=handOfCard[n].AIdraw();
            handOfCard[n].num[handOfCard[n].hand[discard]]--;
            str1+="<img src='"+dictionary[handOfCard[n].hand[discard]]+".png'>  ";
            [handOfCard[n].hand[discard],handOfCard[n].hand[16]]=[handOfCard[n].hand[16],handOfCard[n].hand[discard]];
            handOfCard[n].hand[16]=34;
            handOfCard[n]._sort();
            display3(str1);
            display(n,handOfCard[n].hand);
        }
        function sleep(n){
            const music=new Audio("sleep.mp3");
            music.addEventListener("ended",function(){
                cont(n);
            },false);
            music.play();
        }
       
        function play(){
            if(current==136-16){
                window.alert("遊戲結束");
                return;
            }
            let n=parseInt(document.getElementById("playerin").value);
            document.getElementById("playerin").value="";
            if(isNaN(n)||n>17||n<=0)
                return;
            n--;
            [handOfCard[0].hand[n],handOfCard[0].hand[16]]=[handOfCard[0].hand[16],handOfCard[0].hand[n]];
            str1+="<img src='"+dictionary[handOfCard[0].hand[16]]+".png'>  ";
            handOfCard[0].num[handOfCard[0].hand[16]]--;
            handOfCard[0].hand[16]=34;
            handOfCard[0]._sort();
            let cnt=0;
            let AIdo=setInterval(function(){
                cnt++;

                handOfCard[cnt].hand[16]=drawCard();
                handOfCard[cnt].num[handOfCard[cnt].hand[16]]++;
                display(cnt,handOfCard[cnt].hand);
                
                sleep(cnt);
                if(current==136-16){
                    window.alert("遊戲結束");
                    clearInterval(AIdo);
                }
                if(cnt==3)
                    clearInterval(AIdo);
            },1000);
            if(current==136-16){
                window.alert("遊戲結束");
                return;
            }
            handOfCard[0].hand[16]=drawCard();
            handOfCard[0].num[handOfCard[0].hand[16]]++;
            display3(str1);
            display(0,handOfCard[0].hand);
            
        }
        document.getElementById("event").addEventListener("click",play,false);
        
        
        //-->
      </script>
   </body>
</html>